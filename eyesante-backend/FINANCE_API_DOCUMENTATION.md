# Finance API Documentation

## Overview

The Finance API provides comprehensive financial management capabilities for the Eyesante Healthcare Management System. It handles invoice generation, payment processing, financial reporting, and insurance management.

**Base URL:** `http://localhost:5025/api/finance`

**Authentication:** All endpoints require JWT Bearer token authentication.

## Invoice Management

### 1. Generate Invoice for Appointment

**Endpoint:** `POST /invoices/generate/{appointmentId}`

**Description:** Automatically generates an invoice for a completed appointment.

**Authorization:** `RECEPTIONIST`, `DOCTOR`, `ACCOUNTANT`, `SUPER_ADMIN`

**Path Parameters:**
- `appointmentId` (Long, required): ID of the appointment

**Response:**
```json
{
  "id": 1,
  "invoiceNumber": "INV-2025-001",
  "invoiceDate": "2025-08-02",
  "dueDate": "2025-08-16",
  "patientId": 1,
  "patientName": "John Doe",
  "patientPhone": "+1234567890",
  "patientEmail": "john.doe@email.com",
  "doctorId": 2,
  "doctorName": "Dr. Jane Smith",
  "doctorSpecialty": "Ophthalmology",
  "appointmentId": 1,
  "subtotal": 150.00,
  "taxAmount": 15.00,
  "discountAmount": 0.00,
  "totalAmount": 165.00,
  "amountPaid": 0.00,
  "balanceDue": 165.00,
  "status": "PENDING",
  "paymentStatus": "PENDING",
  "paymentMethod": null,
  "paymentReference": null,
  "paymentDate": null,
  "insuranceProvider": null,
  "insuranceNumber": null,
  "insuranceCoverage": null,
  "insuranceAmount": null,
  "notes": "Consultation fee",
  "internalNotes": null,
  "invoiceItems": [
    {
      "id": 1,
      "invoiceId": 1,
      "itemName": "Eye Consultation",
      "itemDescription": "Comprehensive eye examination",
      "itemType": "CONSULTATION",
      "quantity": 1,
      "unitPrice": 150.00,
      "totalPrice": 150.00,
      "discountPercentage": 0.00,
      "discountAmount": 0.00,
      "finalPrice": 150.00,
      "taxPercentage": 10.00,
      "taxAmount": 15.00,
      "insuranceCovered": false,
      "insuranceCoveragePercentage": 0.00,
      "insuranceAmount": 0.00,
      "notes": null
    }
  ],
  "createdAt": "2025-08-02T22:00:00",
  "updatedAt": "2025-08-02T22:00:00",
  "createdBy": "system",
  "updatedBy": "system"
}
```

### 2. Get Invoice by ID

**Endpoint:** `GET /invoices/{id}`

**Description:** Retrieves a specific invoice by its ID.

**Authorization:** `RECEPTIONIST`, `DOCTOR`, `ACCOUNTANT`, `SUPER_ADMIN`

**Path Parameters:**
- `id` (Long, required): Invoice ID

**Response:** Same as above

### 3. Get Invoice by Invoice Number

**Endpoint:** `GET /invoices/number/{invoiceNumber}`

**Description:** Retrieves an invoice by its invoice number.

**Authorization:** `RECEPTIONIST`, `DOCTOR`, `ACCOUNTANT`, `SUPER_ADMIN`

**Path Parameters:**
- `invoiceNumber` (String, required): Invoice number (e.g., "INV-2025-001")

**Response:** Same as above

### 4. Get All Invoices (Paginated)

**Endpoint:** `GET /invoices`

**Description:** Retrieves all invoices with pagination support.

**Authorization:** `ACCOUNTANT`, `SUPER_ADMIN`

**Query Parameters:**
- `page` (Integer, optional): Page number (default: 0)
- `size` (Integer, optional): Page size (default: 20)
- `sort` (String, optional): Sort field (e.g., "invoiceDate,desc")

**Response:**
```json
{
  "content": [
    {
      "id": 1,
      "invoiceNumber": "INV-2025-001",
      "invoiceDate": "2025-08-02",
      "patientName": "John Doe",
      "doctorName": "Dr. Jane Smith",
      "totalAmount": 165.00,
      "balanceDue": 165.00,
      "status": "PENDING",
      "paymentStatus": "PENDING"
    }
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 20,
    "sort": {
      "sorted": true,
      "unsorted": false
    }
  },
  "totalElements": 1,
  "totalPages": 1,
  "last": true,
  "first": true,
  "numberOfElements": 1
}
```

### 5. Get Invoices by Patient

**Endpoint:** `GET /invoices/patient/{patientId}`

**Description:** Retrieves all invoices for a specific patient.

**Authorization:** `RECEPTIONIST`, `DOCTOR`, `ACCOUNTANT`, `SUPER_ADMIN`

**Path Parameters:**
- `patientId` (Long, required): Patient ID

**Query Parameters:** Same pagination parameters as above

**Response:** Same paginated response format

### 6. Get Invoices by Doctor

**Endpoint:** `GET /invoices/doctor/{doctorId}`

**Description:** Retrieves all invoices generated by a specific doctor.

**Authorization:** `DOCTOR`, `ACCOUNTANT`, `SUPER_ADMIN`

**Path Parameters:**
- `doctorId` (Long, required): Doctor ID

**Query Parameters:** Same pagination parameters as above

**Response:** Same paginated response format

### 7. Get Invoices by Status

**Endpoint:** `GET /invoices/status/{status}`

**Description:** Retrieves invoices filtered by invoice status.

**Authorization:** `ACCOUNTANT`, `SUPER_ADMIN`

**Path Parameters:**
- `status` (String, required): Invoice status (DRAFT, PENDING, SENT, PAID, OVERDUE, CANCELLED, REFUNDED)

**Query Parameters:** Same pagination parameters as above

**Response:** Same paginated response format

### 8. Get Invoices by Payment Status

**Endpoint:** `GET /invoices/payment-status/{paymentStatus}`

**Description:** Retrieves invoices filtered by payment status.

**Authorization:** `ACCOUNTANT`, `SUPER_ADMIN`

**Path Parameters:**
- `paymentStatus` (String, required): Payment status (PENDING, PARTIAL, PAID, OVERDUE, REFUNDED)

**Query Parameters:** Same pagination parameters as above

**Response:** Same paginated response format

### 9. Get Invoices by Date Range

**Endpoint:** `GET /invoices/date-range`

**Description:** Retrieves invoices within a specific date range.

**Authorization:** `ACCOUNTANT`, `SUPER_ADMIN`

**Query Parameters:**
- `startDate` (Date, required): Start date (YYYY-MM-DD format)
- `endDate` (Date, required): End date (YYYY-MM-DD format)
- Same pagination parameters as above

**Response:** Same paginated response format

### 10. Get Overdue Invoices

**Endpoint:** `GET /invoices/overdue`

**Description:** Retrieves all overdue invoices.

**Authorization:** `ACCOUNTANT`, `SUPER_ADMIN`

**Response:**
```json
[
  {
    "id": 1,
    "invoiceNumber": "INV-2025-001",
    "invoiceDate": "2025-08-02",
    "dueDate": "2025-08-16",
    "patientName": "John Doe",
    "totalAmount": 165.00,
    "balanceDue": 165.00,
    "status": "OVERDUE",
    "paymentStatus": "OVERDUE"
  }
]
```

### 11. Get Invoices with Balance Due

**Endpoint:** `GET /invoices/balance-due`

**Description:** Retrieves invoices that have outstanding balances.

**Authorization:** `ACCOUNTANT`, `SUPER_ADMIN`

**Query Parameters:** Same pagination parameters as above

**Response:** Same paginated response format

## Payment Management

### 12. Record Payment for Invoice

**Endpoint:** `POST /invoices/{id}/payment`

**Description:** Records a payment for an invoice.

**Authorization:** `RECEPTIONIST`, `ACCOUNTANT`, `SUPER_ADMIN`

**Path Parameters:**
- `id` (Long, required): Invoice ID

**Query Parameters:**
- `amount` (BigDecimal, required): Payment amount
- `method` (String, required): Payment method (CASH, MOBILE_MONEY, BANK_TRANSFER, CARD, INSURANCE, CHEQUE)
- `reference` (String, optional): Payment reference number

**Response:** Updated invoice with payment information

### 13. Update Invoice Status

**Endpoint:** `PUT /invoices/{id}/status`

**Description:** Updates the status of an invoice.

**Authorization:** `ACCOUNTANT`, `SUPER_ADMIN`

**Path Parameters:**
- `id` (Long, required): Invoice ID

**Query Parameters:**
- `status` (String, required): New status (DRAFT, PENDING, SENT, PAID, OVERDUE, CANCELLED, REFUNDED)

**Response:** Updated invoice

## Financial Reporting

### 14. Get Financial Summary

**Endpoint:** `GET /summary`

**Description:** Retrieves financial summary for a specific date range.

**Authorization:** `ACCOUNTANT`, `SUPER_ADMIN`

**Query Parameters:**
- `startDate` (Date, required): Start date (YYYY-MM-DD format)
- `endDate` (Date, required): End date (YYYY-MM-DD format)

**Response:**
```json
{
  "startDate": "2025-08-01",
  "endDate": "2025-08-31",
  "totalInvoices": 150,
  "totalRevenue": 25000.00,
  "totalPaid": 22000.00,
  "totalOutstanding": 3000.00,
  "totalOverdue": 1500.00,
  "averageInvoiceAmount": 166.67,
  "paymentMethodBreakdown": {
    "CASH": 8000.00,
    "MOBILE_MONEY": 7000.00,
    "BANK_TRANSFER": 5000.00,
    "CARD": 3000.00,
    "INSURANCE": 2000.00
  },
  "statusBreakdown": {
    "PAID": 120,
    "PENDING": 20,
    "OVERDUE": 10
  },
  "topDoctors": [
    {
      "doctorId": 1,
      "doctorName": "Dr. Jane Smith",
      "totalInvoices": 45,
      "totalRevenue": 7500.00
    }
  ],
  "topServices": [
    {
      "serviceName": "Eye Consultation",
      "totalInvoices": 80,
      "totalRevenue": 12000.00
    }
  ]
}
```

## Data Models

### Invoice Status Values
- `DRAFT`: Invoice is in draft state
- `PENDING`: Invoice is pending approval
- `SENT`: Invoice has been sent to patient
- `PAID`: Invoice has been fully paid
- `OVERDUE`: Invoice is past due date
- `CANCELLED`: Invoice has been cancelled
- `REFUNDED`: Invoice has been refunded

### Payment Status Values
- `PENDING`: Payment is pending
- `PARTIAL`: Partial payment has been made
- `PAID`: Full payment has been made
- `OVERDUE`: Payment is overdue
- `REFUNDED`: Payment has been refunded

### Payment Method Values
- `CASH`: Cash payment
- `MOBILE_MONEY`: Mobile money payment
- `BANK_TRANSFER`: Bank transfer
- `CARD`: Credit/debit card
- `INSURANCE`: Insurance payment
- `CHEQUE`: Cheque payment

## Error Responses

### 400 Bad Request
```json
{
  "status": 400,
  "error": "Bad Request",
  "message": "Invalid invoice status provided",
  "path": "/api/finance/invoices/1/status",
  "timestamp": "2025-08-02T22:00:00"
}
```

### 401 Unauthorized
```json
{
  "status": 401,
  "error": "Unauthorized",
  "message": "Access denied. Please provide valid authentication credentials.",
  "path": "/api/finance/invoices",
  "timestamp": "2025-08-02T22:00:00"
}
```

### 403 Forbidden
```json
{
  "status": 403,
  "error": "Forbidden",
  "message": "Access denied. Insufficient privileges.",
  "path": "/api/finance/summary",
  "timestamp": "2025-08-02T22:00:00"
}
```

### 404 Not Found
```json
{
  "status": 404,
  "error": "Not Found",
  "message": "Invoice not found with ID: 999",
  "path": "/api/finance/invoices/999",
  "timestamp": "2025-08-02T22:00:00"
}
```

### 500 Internal Server Error
```json
{
  "status": 500,
  "error": "Internal Server Error",
  "message": "An unexpected error occurred. Please try again later.",
  "path": "/api/finance/invoices",
  "timestamp": "2025-08-02T22:00:00"
}
```

## Usage Examples

### Generate Invoice for Appointment
```bash
curl -X POST http://localhost:5025/api/finance/invoices/generate/1 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json"
```

### Record Payment
```bash
curl -X POST "http://localhost:5025/api/finance/invoices/1/payment?amount=165.00&method=CASH&reference=PAY-001" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Get Financial Summary
```bash
curl -X GET "http://localhost:5025/api/finance/summary?startDate=2025-08-01&endDate=2025-08-31" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Get Overdue Invoices
```bash
curl -X GET http://localhost:5025/api/finance/invoices/overdue \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## Notes

1. **Automatic Invoice Generation**: Invoices are automatically generated when appointments are marked as completed.

2. **Payment Processing**: The system supports multiple payment methods and tracks payment history.

3. **Insurance Integration**: The system can handle insurance claims and coverage calculations.

4. **Audit Trail**: All financial transactions include audit information (created/updated by, timestamps).

5. **Role-Based Access**: Different user roles have different levels of access to financial data:
   - `RECEPTIONIST`: Can generate invoices and record payments
   - `DOCTOR`: Can generate invoices and view their own invoices
   - `ACCOUNTANT`: Full access to all financial operations
   - `SUPER_ADMIN`: Full access to all financial operations

6. **Data Validation**: All financial data is validated for accuracy and consistency.

7. **Reporting**: Comprehensive financial reporting capabilities for business intelligence.
